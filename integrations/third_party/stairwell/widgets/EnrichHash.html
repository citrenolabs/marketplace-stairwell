<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stairwell Object Enrichment Report</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/2.1.0/showdown.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark gray background */
        }
        .yara-match-item {
          overflow-wrap: break-word;
        }
        /* Custom styles for the AI summary content on a dark background */
        .prose { color: #d1d5db; }
        .prose h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; border-bottom: 1px solid #374151; padding-bottom: 0.25rem; color: #f3f4f6; }
        .prose h3 { font-size: 1.1rem; font-weight: 600; margin-top: 1.25rem; margin-bottom: 0.5rem; color: #f3f4f6; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; }
        .prose li { margin-bottom: 0.25rem; }
        .prose p { line-height: 1.6; margin-bottom: 1rem; }
        .prose strong { font-weight: 600; color: #ffffff; }
        .prose code { background-color: #374151; color: #d1d5db; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875rem; }
        .prose.summary {
            text-align: justify;
            word-break: normal;
            overflow-wrap: normal;
        }
    </style>
</head>
<body class="text-gray-200">

    <div id="reports-container" class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-12">
    </div>

    <script>
        let enrichmentDataArray = [];
        if ('[Stairwell_Enrich Hash_1.is_success]' == 'true') { 
            enrichmentDataArray = [Stairwell_Enrich Hash_1.JsonResult]; 
        }

        function formatBytes(bytes, decimals = 2) {
            bytes = parseInt(bytes);
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }
        
        function copyToClipboard(text, button) {
            const originalContent = button.innerHTML;
            navigator.clipboard.writeText(text).then(() => {
                button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-lg text-green-400" viewBox="0 0 16 16"><path d="M12.736 3.97a.733.733 0 0 1 1.047 0c.286.289.29.756.01 1.05L7.88 12.01a.733.733 0 0 1-1.065.02L3.217 8.384a.757.757 0 0 1 0-1.06.733.733 0 0 1 1.047 0l3.052 3.093 5.4-6.425z"/></svg>`;
                setTimeout(() => { button.innerHTML = originalContent; }, 2000);
            }).catch(err => { console.error('Failed to copy: ', err); });
        }

        function renderReport(data) {
            data = data.EntityResult; // Access the nested object containing the report details.

            const reportContainer = document.createElement('div');
            reportContainer.className = 'report-card';
            
            // --- Build Hashes HTML ---
            const hashKeys = {'SHA256': data.fileHashSha256, 'SHA1': data.fileHashSha1, 'MD5': data.fileHashMd5, 'IMPHASH': data.fileHashImphash, 'Sorted IMPHASH': data.fileHashSortedImphash, 'TLSH': data.fileHashTlsh};
            let hashesHtml = Object.entries(hashKeys).map(([name, value]) => {
                if (!value) return '';
                return `
                            <div class="flex items-center justify-between">
                                <span class="text-gray-400 font-medium">${name}</span>
                                <div class="flex items-center gap-2 min-w-0"> 
                                    <span class="text-gray-300 font-mono truncate" title="${value}">${value}</span>
                                    <button class="copy-btn flex-shrink-0 flex items-center text-gray-500 hover:text-blue-400 transition" title="Copy ${name}" data-copy-value="${value}">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"/></svg>
                                    </button>
                                </div>
                            </div>`;
            }).join('');

            // --- Build Detections HTML ---
            let detectionsHtml = '';
            if (data.verdictMalevalLabels && data.verdictMalevalLabels.length > 0) {
                const labels = data.verdictMalevalLabels.map(label => `<span class="bg-blue-900 text-blue-200 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded">${label}</span>`).join('');
                detectionsHtml += `<div class="mb-3"><h3 class="text-gray-400 font-medium mb-1">Labels</h3><div class="flex flex-wrap">${labels}</div></div>`;
            }
            if (data.verdictYaraRuleMatches && data.verdictYaraRuleMatches.length > 0) {
                const rules = data.verdictYaraRuleMatches.map(rule => `<li class="yara-match-item text-gray-300 font-mono text-xs">${rule}</li>`).join('');
                detectionsHtml += `<div><h3 class="text-gray-400 font-medium mb-1">Yara Matches</h3><ul class="list-disc list-inside">${rules}</ul></div>`;
            }
            if (!detectionsHtml) detectionsHtml = '<p class="text-sm text-gray-500">No specific detections.</p>';

            // --- Build Indicators HTML ---
            let indicatorsHtml = '';
            if (data.indicatorsIpsLikely && data.indicatorsIpsLikely.length > 0) {
                const ips = data.indicatorsIpsLikely.map(ip => `<li class="text-gray-300 font-mono text-xs">${ip}</li>`).join('');
                indicatorsHtml += `<div><h3 class="text-gray-400 font-medium mb-1">Likely IP Addresses</h3><ul class="list-disc list-inside">${ips}</ul></div>`;
            }
            if (data.indicatorsHostnamesLikely && data.indicatorsHostnamesLikely.length > 0) {
                const hostnames = data.indicatorsHostnamesLikely.map(h => `<li class="text-gray-300 font-mono text-xs">${h}</li>`).join('');
                indicatorsHtml += `<div><h3 class="text-gray-400 font-medium mb-1">Likely Hostnames</h3><ul class="list-disc list-inside">${hostnames}</ul></div>`;
            }
            if (data.indicatorsHostnamesPrivate && data.indicatorsHostnamesPrivate.length > 0) {
                const privateHostnames = data.indicatorsHostnamesPrivate.map(h => `<li class="text-gray-300 font-mono text-xs">${h}</li>`).join('');
                indicatorsHtml += `<div><h3 class="text-gray-400 font-medium mb-1">Private Hostnames</h3><ul class="list-disc list-inside">${privateHostnames}</ul></div>`;
            }
            if (!indicatorsHtml) indicatorsHtml = '<p class="text-sm text-gray-500">No indicators found.</p>';
            
            // --- Build Variants HTML ---
            let variantsHtml = '';
            if (data.variants && data.variants.length > 0) {
                variantsHtml = data.variants.map(variant => `<li class="text-gray-300 font-mono text-xs">${variant}</li>`).join('');
                variantsHtml = `<ul class="list-disc list-inside">${variantsHtml}</ul>`;
            } else {
                variantsHtml = '<p class="text-sm text-gray-500">No variants found.</p>';
            }

            // --- Build Signature HTML ---
            let signatureHtml = '';
            if (data.signature && data.signature.x509Certificates) {
                const verificationStatus = data.signature.pkcs7VerificationResult || 'UNKNOWN';
                const statusColor = verificationStatus === 'VALID' ? 'text-green-400' : 'text-red-400';
                signatureHtml += `<div class="flex justify-between items-center mb-3"><span class="text-gray-400 font-medium">Verification</span><span class="font-semibold ${statusColor}">${verificationStatus}</span></div>`;

                data.signature.x509Certificates.forEach(cert => {
                    signatureHtml += `
                                <div class="pt-2 mt-2 border-t border-gray-700">
                                    <p class="text-xs text-gray-400">Subject: <span class="text-gray-300 font-medium">${cert.subject || 'N/A'}</span></p>
                                    <p class="text-xs text-gray-400 mt-1">Issuer: <span class="text-gray-300 font-medium">${cert.issuer || 'N/A'}</span></p>
                                    <p class="text-xs text-gray-400 mt-1">Valid From: <span class="text-gray-300 font-mono">${formatDate(cert.earliestValidTime)}</span></p>
                                    <p class="text-xs text-gray-400 mt-1">Valid To: <span class="text-gray-300 font-mono">${formatDate(cert.latestValidTime)}</span></p>
                                </div>`;
                });
            } else {
                signatureHtml = '<p class="text-sm text-gray-500">No signature information.</p>';
            }

            // --- Build Opinions HTML ---
            let opinionsHtml = '';
            if (data.opinionsMostRecent && data.opinionsMostRecent.length > 0) {
                opinionsHtml = data.opinionsMostRecent.map(opinion => {
                    const verdictColor = opinion.verdict === 'MALICIOUS' ? 'text-red-400' : 'text-green-400';
                    return `
                                <div class="pt-2 border-t border-gray-700 first:border-t-0 first:pt-0">
                                     <div class="flex justify-between items-center">
                                         <span class="font-semibold ${verdictColor}">${opinion.verdict}</span>
                                         <span class="text-gray-400 text-xs">${formatDate(opinion.createTime)}</span>
                                     </div>
                                     <div class="text-xs text-gray-500 mt-1">by ${opinion.email || 'Anonymous'}</div>
                                </div>`;
                }).join('');
            } else {
                opinionsHtml = '<p class="text-sm text-gray-500">No opinions submitted.</p>';
            }
            
            // --- Build Comments HTML ---
            let commentsHtml = '';
            if(data.commentsMostRecent && data.commentsMostRecent.length > 0) {
                commentsHtml = data.commentsMostRecent.map(comment => `
                    <div class="pt-2 border-t border-gray-700 first:border-t-0 first:pt-0">
                        <p class="text-gray-300 text-sm">"${comment.body}"</p>
                        <div class="text-xs text-gray-500 mt-1 text-right"> - ${comment.email || 'Anonymous'} on ${formatDate(comment.createTime)}</div>
                    </div>
                `).join('');
            } else {
                commentsHtml = '<p class="text-sm text-gray-500">No comments.</p>';
            }

            // --- Build AI Summary ---
            const showdownConverter = new showdown.Converter({ ghCompatibleHeaderId: true, simpleLineBreaks: true });
            let summaryHtml = showdownConverter.makeHtml(data.summaryAi || 'No AI summary available.');
            if (data.summaryRtg) {
                 summaryHtml += `<h3 class="mt-6">RTG Summary</h3>` + showdownConverter.makeHtml(data.summaryRtg);
            }

            // --- Assemble Full Report ---
            reportContainer.innerHTML = `
                <div class="mb-8 flex justify-between items-start">
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold text-white">Object Enrichment Report</h1>
                        <p class="text-sm text-gray-400 mt-1 break-all">${data.fileHashSha256}</p>
                    </div>
                    <div class="w-28 h-auto flex-shrink-0 ml-4">
                        <svg class="anchor_monogram" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 141 45"><path fill="url(#headerLogoGradient)" fill-rule="evenodd" d="M128.18.796v29.66l12.25-1.44v-5.26l-5.989.702V.063l-6.261.733Zm-14.352 31.339V2.477l6.262-.735V26.14l5.988-.703v5.258l-12.25 1.44Zm-26.48 3.101 4.976-.584 4.824-30.215-5.64.662-2.176 15.492-1.867-15.025-4.121.483-1.867 15.457L79.57 6.48l-6.144.72 4.781 29.11 5.25-.62 1.945-13.499 1.946 13.045ZM48.46 39.788v-29.66l6.223-.729v29.66l-6.223.73Zm-40.2 5.075C3.517 45.427.25 42.985.25 39.98v-3.966l5.832-.684v2.781c0 1.113.7 1.845 1.906 1.704.512-.06.903-.226 1.18-.503.215-.213.363-.492.45-.837l.027-.143.027-.162.023-.27.004-.212c0-2.443-1.672-4.253-4.394-6.494C2.504 28.853.602 25.962.602 22.587c0-4.04 2.8-7.555 7.816-8.143 1.848-.217 3.508.155 4.777.902 1.563.918 2.532 2.404 2.532 4.061v3.969l-5.872.688v-3.005c0-1.04-.62-1.634-1.437-1.539-.816.096-1.637.859-1.637 1.897 0 2.226.664 2.889 3.774 6.01l.375.376c2.398 2.386 4.953 4.924 4.953 8.937l-.012.455-.035.425-.059.396-.043.248a7.995 7.995 0 0 1-2.03 3.927 8.521 8.521 0 0 1-1.786 1.444 8.829 8.829 0 0 1-3.656 1.228ZM41.966 10.89l-7.426.869-4.125 30.141 5.516-.646.468-3.784-2.566-.595 5.488-.643.395 4.588 6.453-.75-4.203-29.18Zm-4.942 20.338 1.168-9.887.79 9.659-1.958.228Zm62.262-27.05 12.25-1.432v4.893l-9.101 1.066 3.074.72v5.668l3.965-.464v5.264l-3.965.463v7.49l6.027-.705v5.263l-12.25 1.436V4.178ZM69.613 22.964c1.594-.965 2.606-2.157 2.606-3.569V12.76c0-3.78-3.617-4.989-6.613-4.639l-7.622.892v29.66l6.223-.729V25.97l.816-.096c.856-.101 1.286.376 1.286.999v6.229l.011 4.595 6.012-.705v-11.08c0-.726-.297-1.329-.805-1.823-.476-.467-1.14-.838-1.914-1.126Zm-3.46-3.3c0 .852-.395 1.23-1.051 1.314l-.895.104v-6.627l-2.574-.603 3.469-.406c.66-.077 1.05.21 1.05 1.063v5.154Zm-49.34-.75v-5.079l14.503-1.698v5.078l-6.617.774 2.574.6v23.68l-6.222.728v-24.58l-4.238.496Z" clip-rule="evenodd"></path><defs><linearGradient id="headerLogoGradient" x1="3.429" x2="138.802" y1="30.407" y2="11.543" gradientUnits="userSpaceOnUse"><stop stop-color="#EB512A"></stop><stop offset=".25" stop-color="#EB5429"></stop><stop offset=".44" stop-color="#EC5E24"></stop><stop offset=".62" stop-color="#ED6F1D"></stop><stop offset=".79" stop-color="#EE8713"></stop><stop offset=".95" stop-color="#F0A505"></stop><stop offset="1" stop-color="#F1B100"></stop></linearGradient></defs></svg>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-1 flex flex-col gap-6">
                        <div class="bg-gray-800 p-5 rounded-lg shadow-2xl"><h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-4">File Details</h2><div class="space-y-3 text-sm">
                            <div class="flex justify-between"><span class="text-gray-400 font-medium">File Size</span><span class="text-gray-300 font-mono">${formatBytes(data.fileSize)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400 font-medium">Entropy</span><span class="text-gray-300 font-mono">${(data.fileEntropy || 0).toFixed(6)}</span></div>
                            <div class="flex justify-between gap-4"><span class="text-gray-400 font-medium flex-shrink-0">Magic</span><span class="text-gray-300 text-right font-mono break-all">${data.fileMagic || 'N/A'}</span></div>
                            <div class="flex justify-between gap-4"><span class="text-gray-400 font-medium flex-shrink-0">MIME Type</span><span class="text-gray-300 text-right font-mono break-all">${data.fileMimeType || 'N/A'}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400 font-medium">First Sighting</span><span class="text-gray-300 font-mono">${formatDate(data.sightingsFirst)}</span></div>
                            <div class="flex justify-between"><span class="text-gray-400 font-medium">Prevalence</span><span class="text-gray-300 font-mono">${data.sightingsPrevalence ? data.sightingsPrevalence.length : 0} sightings</span></div>
                            <div class="flex justify-between"><span class="text-gray-400 font-medium">Well Known</span><span class="text-gray-300 font-mono">${data.verdictIsWellKnown ? 'Yes' : 'No'}</span></div>
                            <div class="flex justify-between items-center"><span class="text-gray-400 font-medium">Malicious Prob.</span><span class="px-2 py-0.5 bg-red-900 text-red-200 rounded-full font-semibold text-xs">${(data.verdictMalevalMaliciousProbability || 'N/A').replace('MALICIOUS_PROBABILITY_', '')}</span></div>
                        </div></div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-2xl"><h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-4">Hashes</h2><div class="space-y-3 text-sm">${hashesHtml}</div></div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-2xl"><h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-4">Detections</h2><div class="space-y-3 text-sm">${detectionsHtml}</div></div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-2xl"><h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-4">Indicators</h2><div class="space-y-3 text-sm">${indicatorsHtml}</div></div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-2xl"><h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-4">Variants</h2><div class="space-y-3 text-sm">${variantsHtml}</div></div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-2xl"><h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-4">Digital Signature</h2><div class="space-y-2 text-sm">${signatureHtml}</div></div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-2xl"><h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-4">Opinions</h2><div class="space-y-2 text-sm">${opinionsHtml}</div></div>
                        <div class="bg-gray-800 p-5 rounded-lg shadow-2xl"><h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-4">Comments</h2><div class="space-y-3 text-sm">${commentsHtml}</div></div>
                    </div>
                    <div class="lg:col-span-2 bg-gray-800 p-5 sm:p-6 rounded-lg shadow-2xl">
                        <h2 class="text-xl font-semibold text-gray-200 border-b border-gray-700 pb-2 mb-4">AI Analysis Summary</h2>
                        <div class="prose max-w-none summary">${summaryHtml}</div>
                    </div>
                </div>
            `;
            
            reportContainer.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation();
                    copyToClipboard(button.dataset.copyValue, e.currentTarget);
                });
            });

            return reportContainer;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const mainContainer = document.getElementById('reports-container');
            if (enrichmentDataArray && enrichmentDataArray.length > 0) {
                enrichmentDataArray.forEach(item => {
                    const reportElement = renderReport(item);
                    mainContainer.appendChild(reportElement);
                });
            } else {
                mainContainer.innerHTML = '<p class="text-center text-gray-400">No enrichment data found.</p>';
            }
        });
    </script>

</body>
</html>